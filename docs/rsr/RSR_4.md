RSR-4: Стандарты логирования
============================

Данный раздел описывает логирование в библиотеках (открытые библиотеки, абстракции, интерфейсы),
сервисах (закрытые реализации компонентов и абстракций). 
Основной целью этого раздела является стандартизация использования логера во всех проектах.

Ключевыми словами «НЕОБХОДИМО» («MUST»), «НЕДОПУСТИМО» («MUST NOT»), «ТРЕБУЕТСЯ» («REQUIRED»), 
«НУЖНО» («SHALL»), «НЕ ПОЗВОЛЯЕТСЯ» («SHALL NOT»), «СЛЕДУЕТ» («SHOULD»), «НЕ СЛЕДУЕТ» («SHOULD NOT»), 
«РЕКОМЕНДУЕТСЯ» («RECOMMENDED»), «ВОЗМОЖНО» («MAY») и «НЕОБЯЗАТЕЛЬНЫЙ» («OPTIONAL») в этом документе 
для интерпретации, как описано в [RFC 2119](http://www.ietf.org/rfc/rfc2119.txt) 
([перевод на русский](http://rfc.com.ru/rfc2119.htm)).

### 1. Базовые стандарты

* ТРЕБУЕТСЯ чтобы все сервисы и приложения использовали логер.
* В качестве логера НЕОБХОДИМО использовать реализации 
[PSR-3 Logger Interface](https://github.com/php-fig/log/blob/master/Psr/Log/LoggerInterface.php).

* В качестве реализации логера РЕКОМЕНДУЕТСЯ использовать
[rollun-com/rollun-logger](https://github.com/rollun-com/rollun-logger).

* В сервисах, библиотеках, приложениях НЕДОПУСТИМО использовать более 1 логер экземпляра.
* Все переменные окружения, которые логеру могут понадобиться НЕОБХОДИМО прокидывать через конфиги.

### 2. Уровни логирование

НЕДОПУСТИМО использовать уровни логирования которые не описаны в [RFC 5424](https://tools.ietf.org/html/rfc5424).
Все уровни логирование делятся на три группы по степени важности логируемой информации:

1. Информация уведомительного характера. Отсутствует любая информация о неправильной работе системы.
    - `debug` - отладочная информация, нужна преимущественно при разработке, логирование происходит только в `debug` 
    режиме (`APP_DEBUG=true`).
    - `info` - информация которая нужна для того чтобы минимально ориентироваться в том что происходит.
    > Пример: микросервис получил запрос на обработку

2. Информация об ошибках работы системы. Обязательна к просмотру разработчиками. Относительно этой информации создаются
`issues`. Ошибки этой группы зачастую обрабатываются в `try catch` блоках.
    - `notice` - информация которая говорит нам о том что система отработала нормально и без ошибок, но при этом возникли 
    аномалии.
    > Пример: запрос к сервису отработал больше ожидаемого времени, но меньше чем таймаут
    
    - `warning` - информация которая говорит нам о том что возникла ошибка, но при этом система может продолжать работу.
    - `error` - ошибка при которой система не может дальше работать.
    
3. Ошибки уровня `critical`, `alert`, `emergency` - информация о которой нужно немедленно сообщить разработчикам.
Такие ошибки имеют наивысший уровень. Обстоятельства при которых нужно логировать ошибки этого уровня принимает команда
во время разработки.


Когда `try catch` блок обрабатывает `exception`, принимается решение или логировать `warning` ошибку 
и продолжать работу или пробрасывать `exception` на уровень выше. Если срабатывает `try catch` наивысшего уровня,
то НЕОБХОДИМО логировать ошибку уровня `error`. 
Всю необходимую информацию о контексте НЕОБХОДИМО записывать в свойство `$message` объекта`exception`.
Если информация не нужна в `error`, тогда лучше перед тем как прокидывать далее `exception`, залогировать данные с уровнем
`dubug`.


### 3. Формат логирования

Так как в качестве логера необходимо использовать PSR-3 интерфейс, правила ниже описываются в контексте этого интерфейса.

* НЕ РЕКОМЕНДУЕТСЯ использовать метод `log` для логирование 
(вместо него лучше использовать методы которые явно указывают уровень логирования).
> Пример: `info`, `debug`, `alert`

* В качества параметра `$message` НЕОБХОДИМО передавать краткое, содержательное сообщение об ошибке.
> Примеры: 'Невозможно записать данные в таблицу', 'Невозможно получить ответ от API'

* РЕКОМЕНДУЕТСЯ в `$message` вставлять основные параметры ошибки, для более содержательного сообщения.
* Все параметры в `$message` НЕОБХОДИМО передавать через `$context`.
* Более объемные данные об ошибке НЕОБХОДИМО выносить в `$context`
> Пример: mysql сообщения, exception stack trace и тд.

* НЕОБХОДИМО помещать `exception` объект в переменную `$context`, если логирование происходит в `try catch` блоке.
* Логеру НЕОБХОДИМО правильно отформатировать `exception` объект и вывести весть `stack trace`.


### 4. Предопределенные переменные контекста

РЕКОМЕНДОВАНО использовать переменные:

* `file` для хранения пути к файлу;
* `datastore` для названия datastore;
* `database` для названия баз данных;
* `table` для названия таблиц баз данных;
* `webhook` для названия webhook;
* `exception` для exception объекта. 


#### Примеры правильного логирования:

1. Пример того когда лучше всего использовать уровень логирование `notice`. Например нормально (и так обычно происходит)
когда запрос отрабатывает до 5 секунд, но на этот раз запрос отработал за 25 секунд, при таймауте (критическому значению).
в 30 секунд. Такое поведение вызывает подозрения, по этому его стоить залогировать.

```php
$logger->notice('Сервис отработал за {time} секунд при таймауете в {timeout} секунд', [
    'time' => 25,
    'timeout' => 30
]);
```

2. Всегда прокидываем `exception` объект в `$context` внутри `try catch` блоков под ключом `exception`.
В примере указан `try catch` наивысшего уровня, поэтому логирование с уровнем `error`.

```php
try {
    // Do something...
} catch (\Exception $e) {
    $logger->error("Can't insert data into {tableName}", [
        'table' => 'someTable',
        'database' => 'someDatabase',
        'exception' => $e,
    ]);
}
```
